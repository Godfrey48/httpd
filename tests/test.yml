---
# file: apache/tests/test.yml

- name: setup python2
  hosts: "{{ vagrant_box }}"
  gather_facts: no

  tasks:
    - raw: sudo apt-get update -qq && sudo apt-get install -qq python2.7
      when: playbook_python2 is defined and
            playbook_python2


- name: tests play
  hosts: "{{ vagrant_box }}"
  gather_facts: yes

  vars:
    debug: yes

    httpd_build_options:
      - '--with-mpm=event'

    httpd_default: |
      ### htcacheclean settings ###

      ## run htcacheclean: yes, no, auto
      ## auto means run if {{ httpd_dir_configuration }}/mods-enabled/cache_disk.load exists
      ## default: auto
      HTCACHECLEAN_RUN=auto

      ## run mode: cron, daemon
      ## run in daemon mode or as daily cron job
      ## default: daemon
      HTCACHECLEAN_MODE=daemon

      ## cache size
      HTCACHECLEAN_SIZE=300M

      ## interval: if in daemon mode, clean cache every x minutes
      HTCACHECLEAN_DAEMON_INTERVAL=120

      ## path to cache
      ## must be the same as in CacheRoot directive
      HTCACHECLEAN_PATH={{ httpd_dir_cache }}/mod_cache_disk

      ## additional options:
      ## -n : be nice
      ## -t : remove empty directories
      HTCACHECLEAN_OPTIONS="-n"

    httpd_modules_enabled:
      - name: mpm_event
        enabled: yes
        configuration: |
          # StartServers: initial number of server processes to start
          StartServers			 2
          # MinSpareThreads: minimum number of worker threads which are kept spare
          MinSpareThreads		 25
          # MaxSpareThreads: maximum number of worker threads which are kept spare
          MaxSpareThreads		 75
          ThreadLimit			 64
          # ThreadsPerChild: constant number of worker threads in each server process
          ThreadsPerChild		 25
          # MaxRequestWorkers: maximum number of worker threads
          MaxRequestWorkers	  150
          # MaxConnectionsPerChild: maximum number of requests a server process serves
          MaxConnectionsPerChild   0
      - name: setenvif
        enabled: yes
        configuration: |
          #
          # The following directives modify normal HTTP response behavior to
          # handle known problems with browser implementations.
          #
          BrowserMatch "Mozilla/2" nokeepalive
          BrowserMatch "MSIE 4\.0b2;" nokeepalive downgrade-1.0 force-response-1.0
          BrowserMatch "RealPlayer 4\.0" force-response-1.0
          BrowserMatch "Java/1\.0" force-response-1.0
          BrowserMatch "JDK/1\.0" force-response-1.0

          #
          # The following directive disables redirects on non-GET requests for
          # a directory that does not include the trailing slash.  This fixes a
          # problem with Microsoft WebFolders which does not appropriately handle
          # redirects for folders with DAV methods.
          # Same deal with Apple's DAV filesystem and Gnome VFS support for DAV.
          #
          BrowserMatch "Microsoft Data Access Internet Publishing Provider" redirect-carefully
          BrowserMatch "MS FrontPage" redirect-carefully
          BrowserMatch "^WebDrive" redirect-carefully
          BrowserMatch "^WebDAVFS/1.[012]" redirect-carefully
          BrowserMatch "^gnome-vfs/1.0" redirect-carefully
          BrowserMatch "^gvfs/1" redirect-carefully
          BrowserMatch "^XML Spy" redirect-carefully
          BrowserMatch "^Dreamweaver-WebDAV-SCM1" redirect-carefully
          BrowserMatch " Konqueror/4" redirect-carefully
      - name: status
        enabled: yes
        configuration: |
          <Location /httpd-status>
              SetHandler server-status
              Require ip 127.0.0.1/32
          </Location>

          ExtendedStatus On

          <IfModule mod_proxy.c>
              ProxyStatus On
          </IfModule>

  pre_tasks:
    - include_vars: "vars/{{ env }}.yml"

  roles:
    - role: httpd

    - role: tests
      tags: test

